# Go
# Build your Go project.
# Add steps that test, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/go

resources:
  repositories:
    - repository: riff
      type: github
      name: projectriff/riff
      endpoint: projectriff

variables:
  GOBIN:  '$(GOPATH)/bin' # Go binaries path
  GOROOT: '/usr/local/go1.11' # Go installation path
  GOPATH: '$(system.defaultWorkingDirectory)/gopath' # Go workspace path
  modulePath: '$(GOPATH)/src/github.com/$(build.repository.name)' # Path to the module's code

jobs:
- job: unit
  strategy:
    matrix:
      linux:
        imageName: 'ubuntu-16.04'
      mac:
        imageName: 'macos-10.13'
#      windows:
#        imageName: 'windows-2019'
  pool:
    vmImage: $(imageName)

  steps:
    - template: ci/install-go-steps.yml@riff
    - script: |
        go version
        make
      workingDirectory: '$(modulePath)'
      displayName: 'Get dependencies, then build'

- job: integration
  dependsOn: unit
  pool:
    vmImage: 'Ubuntu-16.04'

  steps:
    - template: ci/start-minikube-steps.yml
    - template: ci/install-kubectl-steps.yml
    - template: ci/setup-local-registry-steps.yml

    - script: |
        git clone --depth 1 https://github.com/projectriff/cnab-riff.git
      workingDirectory: '$(modulePath)/..'
      displayName: 'clone cnab-riff'

    - script: |
        ./cnab/app/run ../cnab-riff/cnab/app/kab/template.yaml
      workingDirectory: '$(modulePath)'
      displayName: 'run install'
      env:
        CNAB_ACTION: install
        LOG_LEVEL: debug
        TARGET_REGISTRY: registry.pfs.svc.cluster.local:5000/testuser

