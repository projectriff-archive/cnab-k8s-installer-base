steps:
- script: sudo apt-get update && sudo apt-get remove moby-engine moby-cli && sudo apt-get install docker.io=18.06.1-0ubuntu1.2~16.04.1
  displayName: 'Downgrade Docker'

- script: |
    curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.0.0/minikube-linux-amd64 && chmod +x minikube && sudo cp minikube /usr/local/bin/ && rm minikube
    sudo minikube start --memory=8192 --cpus=4 \
    --kubernetes-version=v1.13.2 \
    --bootstrapper=kubeadm \
    --vm-driver=none \
    --extra-config=apiserver.enable-admission-plugins="LimitRanger,NamespaceExists,NamespaceLifecycle,ResourceQuota,ServiceAccount,DefaultStorageClass,MutatingAdmissionWebhook" \
    --insecure-registry registry.pfs.svc.cluster.local:5000
    sudo minikube update-context
  displayName: 'install and start minikube'
  env:
    CHANGE_MINIKUBE_NONE_USER: true

- script: |
    sudo chown -R $USER $HOME/.kube
    sudo chgrp -R $USER $HOME/.kube
    sudo chown -R $USER $HOME/.minikube
    sudo chgrp -R $USER $HOME/.minikube
  displayName: 'change owner'
